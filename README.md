# 🚗 YOLOv8 車輛標註工具 v2.0

專為車輛檢測設計的專業級標註工具，集成AI自動預標註、高效能圖像處理、多格式匯出等功能。

## 📋 目錄

- [功能特色](#功能特色)
- [技術規格](#技術規格)
- [系統需求](#系統需求)
- [安裝指南](#安裝指南)
- [快速入門](#快速入門)
- [功能詳解](#功能詳解)
- [操作指南](#操作指南)
- [快捷鍵表](#快捷鍵表)
- [匯出格式](#匯出格式)
- [AI功能說明](#ai功能說明)
- [疑難排解](#疑難排解)
- [更新記錄](#更新記錄)

## ✨ 功能特色

### 🎯 核心功能
- **智慧車輛分類**：支援機車、汽車、卡車、公車等多種車型
- **AI自動預標註**：整合YOLOv8模型，一鍵自動檢測與標註
- **精確標註工具**：八手柄編輯器，支援像素級精準調整
- **批次處理**：支援資料夾批次載入、AI批次預測、批次匯出
- **多格式匯出**：YOLO、COCO、Pascal VOC、JSON等格式

### 🚀 進階功能
- **效能優化**：大圖片載入優化、智慧快取管理、記憶體監控
- **專案管理**：最近檔案、專案保存、自動備份機制
- **專業UI**：現代化深色主題、可調整視窗佈局、工具列自訂
- **快捷操作**：完整快捷鍵支援、快速車種切換、一鍵視圖控制

### 🔧 系統工具
- **記憶體監控**：即時監控系統資源使用狀況
- **快取管理**：智慧圖片快取，提升大檔案處理效率
- **錯誤處理**：完善的錯誤日誌與恢復機制

## 📊 技術規格

### 架構設計
```
├── main.py                 # 主程式入口
├── annotator.py           # 標註引擎
├── ai_assistant.py        # AI輔助模組
├── performance_optimizer.py # 效能優化
├── advanced_exporter.py   # 多格式匯出
├── file_manager.py        # 檔案管理
└── requirements.txt       # 依賴清單
```

### 技術棧
- **GUI框架**：PyQt5 5.15.11
- **AI引擎**：YOLOv8 (Ultralytics 8.3.179)
- **圖像處理**：OpenCV 4.12.0.88、Pillow 11.3.0
- **深度學習**：PyTorch 2.8.0、TorchVision 0.23.0
- **數據處理**：NumPy 2.2.6、Pandas 2.3.1
- **系統監控**：psutil 7.0.0

## 💻 系統需求

### 最低需求
- **作業系統**：Windows 10/11、macOS 10.14+、Ubuntu 18.04+
- **Python**：3.8 或以上版本
- **記憶體**：4GB RAM
- **硬碟空間**：2GB 可用空間

### 建議配置
- **記憶體**：8GB RAM 或以上
- **顯示卡**：支援CUDA的NVIDIA GPU（AI功能加速）
- **處理器**：Intel i5 或 AMD Ryzen 5 以上
- **解析度**：1920x1080 或以上

## 🛠 安裝指南

### 方法一：一鍵安裝腳本

```bash
# 1. 下載專案
git clone https://github.com/ericchen2023/yolo-vehicle-annotator.git
cd yolo-vehicle-annotator

# 2. 執行安裝腳本（自動建立虛擬環境）
# Windows
install.bat

# macOS/Linux
./install.sh
```

### 方法二：手動安裝

```bash
# 1. 建立虛擬環境
python -m venv .venv

# 2. 啟動虛擬環境
# Windows
.venv\Scripts\activate
# macOS/Linux
source .venv/bin/activate

# 3. 安裝依賴
pip install -r requirements.txt

# 4. 啟動程式
python main.py
```

### 驗證安裝

執行測試腳本確認所有功能正常：

```bash
python test_features.py
```

## 🚀 快速入門

### 第一次使用

1. **啟動程式**
   ```bash
   python main.py
   ```

2. **載入圖片**
   - 單張圖片：`Ctrl+O`
   - 整個資料夾：`Ctrl+Shift+O`

3. **開始標註**
   - 滑鼠拖拽繪製邊界框
   - 選擇車輛類型（數字鍵1-4）
   - AI自動預標註：`F5`

4. **匯出結果**
   - YOLO格式：`Ctrl+S`
   - 批次匯出：`Ctrl+Shift+S`
   - 多格式匯出：`Ctrl+E`

### 基本工作流程

```mermaid
graph LR
    A[載入圖片] --> B[AI預標註]
    B --> C[手動調整]
    C --> D[匯出標註]
    D --> E[下一張圖片]
    E --> B
```

## 📖 功能詳解

### 標註功能

#### 標註工具
- **繪製模式**：滑鼠拖拽建立邊界框
- **編輯模式**：八手柄調整，支援移動、縮放
- **選擇工具**：點擊選中、框選多個標註
- **車種分類**：4種預設車輛類型，可自訂擴充

#### 標註編輯
```
🎯 八手柄編輯器
┌─────────────────┐
│ ●     ●     ● │
│   邊界框編輯    │
│ ●     ●     ● │
│ ●     ●     ● │
└─────────────────┘
- 角落控點：等比例縮放
- 邊緣控點：單軸縮放
- 框內拖拽：整體移動
```

#### 車輛類型
| 編號 | 車種 | 快捷鍵 | 顏色 |
|------|------|--------|------|
| 0 | 機車 | `1` | 🔴 紅色 |
| 1 | 汽車 | `2` | 🟢 綠色 |
| 2 | 卡車 | `3` | 🔵 藍色 |
| 3 | 公車 | `4` | 🟡 黃色 |

### AI輔助功能

#### AI預測引擎
- **模型**：YOLOv8n/YOLOv8x（可切換）
- **精準度**：支援信心度閾值調整（0.1-0.9）
- **速度**：CUDA加速，CPU備援支援
- **類別映射**：COCO類別自動映射到車輛類型

#### 使用方式
1. **單張預測**：`F5` 或點擊 🤖 AI預測
2. **批次處理**：`Ctrl+F5` 或點擊 🔄 批次AI
3. **設定調整**：`F6` 進入AI設定介面

#### 預測確認介面
```
┌─────────────────────────────┐
│ AI預測結果確認              │
├─────────────────────────────┤
│ ☑ 汽車 (信心度: 0.89)      │
│ ☑ 卡車 (信心度: 0.76)      │
│ ☐ 機車 (信心度: 0.45)      │
├─────────────────────────────┤
│ [全選] [反選] [確認] [取消] │
└─────────────────────────────┘
```

### 效能優化

#### 記憶體管理
- **智慧快取**：LRU演算法管理圖片快取
- **預載機制**：背景預載前後圖片
- **記憶體監控**：即時顯示系統資源使用

#### 大圖處理
- **分層載入**：大圖片分層顯示機制
- **縮放優化**：GPU加速圖片縮放
- **背景處理**：多執行緒圖片處理

```python
# 效能設定範例
cache_settings = {
    "max_cache_size": "100MB",    # 最大快取大小
    "preload_count": 3,           # 預載圖片數量
    "background_workers": 4       # 背景處理執行緒
}
```

## 🎮 操作指南

### 檔案操作

#### 載入圖片
1. **單張載入**：
   - `Ctrl+O` 開啟檔案對話框
   - 支援格式：JPG、PNG、BMP、TIFF

2. **資料夾載入**：
   - `Ctrl+Shift+O` 載入整個資料夾
   - 自動過濾圖片檔案
   - 支援巢狀資料夾掃描

#### 專案管理
- **最近檔案**：`Ctrl+H` 快速開啟最近使用的檔案
- **專案管理**：`Ctrl+P` 管理多個標註專案
- **自動備份**：定時自動備份標註進度

### 標註操作

#### 基本標註
1. **建立標註**：
   - 滑鼠左鍵拖拽繪製矩形
   - 釋放滑鼠完成標註

2. **選擇標註**：
   - 點擊標註邊框選中
   - `Ctrl+A` 全選所有標註

3. **編輯標註**：
   - 拖拽八個控制點調整大小
   - 框內拖拽移動位置

#### 進階操作
- **複製貼上**：`Ctrl+C` / `Ctrl+V`
- **撤銷重做**：`Ctrl+Z` / `Ctrl+Y`
- **刪除標註**：`Delete` 鍵或 `Ctrl+Delete`

### 視圖控制

#### 縮放操作
- **滑鼠滾輪**：縮放圖片
- **鍵盤快捷鍵**：
  - `Ctrl++`：放大
  - `Ctrl+-`：縮小
  - `Ctrl+0`：適應視窗
  - `Ctrl+1`：實際大小

#### 導航控制
- **鍵盤導航**：
  - `←/→` 或 `A/D`：上/下一張
  - `Space`：下一張
  - `Shift+Space`：上一張
  - `Page Up/Down`：翻頁

#### 視圖模式
- **全螢幕**：`F9` 切換全螢幕模式
- **隱藏UI**：`F11` 隱藏工具列和面板
- **隱藏標註**：`F10` 暫時隱藏所有標註

## ⌨️ 快捷鍵表

### 檔案操作
| 功能 | 快捷鍵 | 說明 |
|------|--------|------|
| 載入圖片 | `Ctrl+O` | 開啟單張圖片 |
| 載入資料夾 | `Ctrl+Shift+O` | 載入整個資料夾 |
| 儲存標註 | `Ctrl+S` | 匯出當前標註 |
| 批次匯出 | `Ctrl+Shift+S` | 批次匯出所有 |
| 進階匯出 | `Ctrl+E` | 多格式匯出 |
| 退出程式 | `Ctrl+Q` | 關閉應用程式 |

### 圖片導航
| 功能 | 快捷鍵 | 說明 |
|------|--------|------|
| 上一張 | `←` `A` `Shift+Space` | 前一張圖片 |
| 下一張 | `→` `D` `Space` | 下一張圖片 |
| 翻頁 | `Page Up/Down` | 快速翻頁 |

### 標註操作
| 功能 | 快捷鍵 | 說明 |
|------|--------|------|
| 刪除選中 | `Delete` | 刪除選中標註 |
| 清除所有 | `Ctrl+Delete` | 清除全部標註 |
| 全選標註 | `Ctrl+A` | 選中所有標註 |
| 清除選擇 | `Escape` | 取消選擇狀態 |
| 車種切換 | `1-4` | 快速切換車輛類型 |

### 視圖控制
| 功能 | 快捷鍵 | 說明 |
|------|--------|------|
| 放大 | `Ctrl++` | 放大視圖 |
| 縮小 | `Ctrl+-` | 縮小視圖 |
| 適應視窗 | `Ctrl+0` `F` | 適應視窗大小 |
| 實際大小 | `Ctrl+1` | 1:1 顯示 |
| 重置視圖 | `Home` `R` | 重置所有設定 |

### AI功能
| 功能 | 快捷鍵 | 說明 |
|------|--------|------|
| AI預測 | `F5` | 當前圖片AI標註 |
| 批次AI | `Ctrl+F5` | 批次AI處理 |
| AI設定 | `F6` | AI參數設定 |

### 系統功能
| 功能 | 快捷鍵 | 說明 |
|------|--------|------|
| 快取管理 | `F7` | 管理圖片快取 |
| 記憶體監控 | `F8` | 系統資源監控 |
| 全螢幕 | `F9` | 切換全螢幕 |
| 隱藏標註 | `F10` | 切換標註顯示 |
| 隱藏UI | `F11` | 切換介面顯示 |
| 幫助 | `F12` | 顯示幫助資訊 |

### 專案管理
| 功能 | 快捷鍵 | 說明 |
|------|--------|------|
| 最近檔案 | `Ctrl+H` | 最近使用檔案 |
| 專案管理 | `Ctrl+P` | 專案管理介面 |

## 📤 匯出格式

### YOLO格式
標準YOLOv8訓練格式，每張圖片對應一個.txt檔案。

```
# 格式：class_id center_x center_y width height（相對座標）
0 0.5 0.5 0.3 0.4
1 0.7 0.3 0.2 0.3
```

**目錄結構**：
```
output/
├── images/
│   ├── img001.jpg
│   └── img002.jpg
└── labels/
    ├── img001.txt
    └── img002.txt
```

### COCO格式
通用物件檢測資料集格式，JSON結構化資料。

```json
{
  "images": [...],
  "annotations": [...],
  "categories": [
    {"id": 0, "name": "motorcycle"},
    {"id": 1, "name": "car"},
    {"id": 2, "name": "truck"},
    {"id": 3, "name": "bus"}
  ]
}
```

### Pascal VOC格式
XML結構化標註格式，廣泛支援。

```xml
<annotation>
  <filename>image.jpg</filename>
  <size>
    <width>1920</width>
    <height>1080</height>
  </size>
  <object>
    <name>car</name>
    <bndbox>
      <xmin>100</xmin>
      <ymin>200</ymin>
      <xmax>300</xmax>
      <ymax>400</ymax>
    </bndbox>
  </object>
</annotation>
```

### JSON格式
自訂JSON格式，包含詳細標註資訊。

```json
{
  "image_path": "image.jpg",
  "image_size": [1920, 1080],
  "annotations": [
    {
      "id": 1,
      "class_id": 1,
      "class_name": "car",
      "bbox": [100, 200, 200, 200],
      "confidence": 1.0,
      "created_by": "manual"
    }
  ],
  "metadata": {
    "created_date": "2025-08-18T10:30:00",
    "tool_version": "2.0",
    "total_annotations": 1
  }
}
```

## 🤖 AI功能說明

### 模型配置

#### 支援模型
- **YOLOv8n**：快速模型，適合即時預覽
- **YOLOv8s**：平衡模型，速度與精度並重  
- **YOLOv8m**：中等模型，高精度應用
- **YOLOv8l**：大型模型，最高精度
- **YOLOv8x**：超大模型，頂級精度

#### 效能對比
| 模型 | 大小 | 速度 | 精度 | 記憶體 |
|------|------|------|------|--------|
| YOLOv8n | 6.2MB | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | 1GB |
| YOLOv8s | 21.5MB | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 2GB |
| YOLOv8m | 49.7MB | ⭐⭐⭐ | ⭐⭐⭐⭐ | 4GB |
| YOLOv8l | 83.7MB | ⭐⭐ | ⭐⭐⭐⭐⭐ | 6GB |
| YOLOv8x | 130.5MB | ⭐ | ⭐⭐⭐⭐⭐ | 8GB |

### AI設定選項

#### 基本設定
```python
ai_settings = {
    "model_type": "yolov8n",           # 模型類型
    "confidence_threshold": 0.5,       # 信心度閾值
    "device": "auto",                  # 設備選擇（auto/cpu/cuda）
    "batch_size": 16,                  # 批次大小
    "max_det": 300                     # 最大檢測數量
}
```

#### 進階設定
```python
advanced_settings = {
    "nms_threshold": 0.45,             # 非極大抑制閾值
    "augment": False,                  # 測試時增強
    "half_precision": True,            # 半精度推理
    "optimize_for_mobile": False       # 移動設備優化
}
```

### 類別映射

COCO資料集類別自動映射到車輛類型：

| COCO類別 | ID | 映射車種 | 信心度權重 |
|----------|----|---------|---------| 
| car | 2 | 汽車 (1) | 1.0 |
| truck | 7 | 卡車 (2) | 1.0 |
| bus | 5 | 公車 (3) | 1.0 |
| motorcycle | 3 | 機車 (0) | 1.0 |
| bicycle | 1 | 機車 (0) | 0.8 |

### 批次處理

#### 工作流程
1. **掃描資料夾**：自動識別圖片檔案
2. **預處理**：圖片尺寸標準化
3. **模型推理**：批次預測處理
4. **後處理**：結果過濾與優化
5. **結果確認**：人工審核介面

#### 效能優化
- **GPU並行**：充分利用GPU資源
- **記憶體管理**：智慧批次大小調整
- **進度追蹤**：即時顯示處理進度
- **錯誤恢復**：失敗圖片自動跳過

### 品質控制

#### 自動品質檢查
- **邊界框驗證**：檢查邊界框有效性
- **重疊檢測**：自動去除重疊標註
- **尺寸過濾**：過濾過小或過大的檢測
- **類別確信度**：基於信心度過濾結果

#### 人工審核介面
```
┌─────────────────────────────────┐
│ AI預測結果審核                  │
├─────────────────────────────────┤
│ 圖片: image001.jpg              │
│ 檢測到: 3 個物件                │
├─────────────────────────────────┤
│ ☑ [汽車] 信心度: 0.89 ✓        │
│ ☑ [卡車] 信心度: 0.76 ✓        │  
│ ☐ [機車] 信心度: 0.45 ⚠        │
├─────────────────────────────────┤
│ [上一張] [接受] [跳過] [下一張] │
└─────────────────────────────────┘
```

## 🔧 疑難排解

### 常見問題

#### 1. 安裝問題

**Q: `pip install torch` 安裝失敗**
```bash
# 解決方案：使用官方安裝命令
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
```

**Q: PyQt5 安裝失敗**
```bash
# Windows 解決方案
pip install PyQt5 --user

# Linux 解決方案  
sudo apt-get install python3-pyqt5
pip install PyQt5
```

#### 2. 效能問題

**Q: 大圖片載入緩慢**
- 啟用快取管理（F7）
- 調整快取大小限制
- 使用SSD硬碟儲存圖片

**Q: AI預測速度慢**
- 檢查CUDA是否正確安裝
- 使用較小的模型（YOLOv8n）
- 調整批次大小設定

#### 3. AI功能問題

**Q: AI預測無結果**
- 檢查信心度閾值設定（建議0.3-0.7）
- 確認圖片中有車輛
- 嘗試不同的模型

**Q: 記憶體不足錯誤**
```python
# 在 ai_settings.py 中調整設定
BATCH_SIZE = 8          # 降低批次大小
MAX_CACHE_SIZE = 50     # 降低快取大小
DEVICE = "cpu"          # 使用CPU模式
```

### 系統最佳化

#### 效能調校
```python
# config/performance.json
{
  "cache_settings": {
    "max_cache_size_mb": 100,
    "enable_preload": true,
    "preload_count": 3
  },
  "gpu_settings": {
    "enable_cuda": true,
    "memory_fraction": 0.8,
    "allow_growth": true
  },
  "display_settings": {
    "max_display_size": [1920, 1080],
    "enable_smooth_scaling": true
  }
}
```

#### 記憶體管理
- **監控用量**：F8 開啟記憶體監控
- **清理快取**：F7 手動清理快取
- **調整設定**：根據系統配置調整快取大小

### 日誌與除錯

#### 啟用除錯模式
```bash
# 設定環境變數
export YOLO_ANNOTATOR_DEBUG=1
python main.py
```

#### 日誌檔案位置
- **Windows**: `%APPDATA%\yolo_annotator\logs\`
- **macOS**: `~/Library/Application Support/yolo_annotator/logs/`
- **Linux**: `~/.local/share/yolo_annotator/logs/`

#### 常見錯誤代碼
| 錯誤代碼 | 說明 | 解決方案 |
|----------|------|----------|
| E001 | 圖片載入失敗 | 檢查檔案格式和權限 |
| E002 | AI模型載入失敗 | 檢查模型檔案和CUDA |
| E003 | 記憶體不足 | 調整快取設定 |
| E004 | 匯出失敗 | 檢查輸出目錄權限 |

## 📝 更新記錄

### v2.0.0 (2025-08-18)
#### 🆕 新功能
- 全新AI自動預標註系統
- 八手柄精確編輯器
- 多格式匯出支援（COCO、Pascal VOC、JSON）
- 效能監控與記憶體管理
- 完整快捷鍵系統

#### 🔧 改進
- 現代化UI設計
- 大圖片載入優化
- 智慧快取管理
- 批次處理效能提升

#### 🐛 修復
- 修復Delete鍵行為
- 移除無用依賴
- 改善記憶體洩漏問題
- 修正標註精度問題

### v1.2.0 (2025-07-15)
#### 🆕 新功能
- 專案管理系統
- 最近檔案清單
- 自動備份機制

#### 🔧 改進
- 提升標註精度
- 優化使用者介面
- 增強錯誤處理

### v1.1.0 (2025-06-20)
#### 🆕 新功能
- 基本AI輔助功能
- 批次匯出功能
- 縮放與導航控制

#### 🐛 修復
- 修復圖片載入問題
- 改善標註儲存機制

### v1.0.0 (2025-05-10)
#### 🎉 首次發布
- 基本標註功能
- YOLO格式匯出
- 多車種分類支援

---

## 📞 技術支援

### 聯絡資訊
- **Github Issues**: [提交問題](https://github.com/ericchen2023/yolo-vehicle-annotator/issues)
- **討論區**: [技術討論](https://github.com/ericchen2023/yolo-vehicle-annotator/discussions)
- **Email**: ericchen20050329@gmail.com

### 貢獻指南
歡迎提交Pull Request和Issue，請參考 [CONTRIBUTING.md](CONTRIBUTING.md)

### 授權條款
本專案採用 MIT 授權條款，詳見 [LICENSE](LICENSE) 檔案。

---

*最後更新: 2025-08-18*  
*版本: v2.0.0*  
*維護者: YOLOv8 Annotator Team*
